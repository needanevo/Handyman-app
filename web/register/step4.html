<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration - Step 4 | The Real Johnson</title>
    <link rel="stylesheet" href="style.css">
    <script src="../auth.js"></script>
</head>
<body>
    <div class="register-container">
        <div class="register-card">
            <div class="logo">
                <a href="/">The Real Johnson</a>
            </div>

            <div class="progress-bar">
                <div class="progress-step completed">1</div>
                <div class="progress-line completed"></div>
                <div class="progress-step completed">2</div>
                <div class="progress-line completed"></div>
                <div class="progress-step completed">3</div>
                <div class="progress-line completed"></div>
                <div class="progress-step active">4</div>
            </div>

            <h1>Portfolio Photos</h1>
            <p class="subtitle">Showcase your best work (optional but highly recommended)</p>

            <div id="error-message" class="error-message" style="display: none;"></div>

            <form id="portfolio-form" class="registration-form">
                <div class="info-box">
                    <strong>Why add portfolio photos?</strong>
                    <p>
                        Customers are 3x more likely to hire contractors with portfolio photos.
                        Show off your best work to stand out and win more jobs!
                    </p>
                </div>

                <!-- Portfolio Photo Uploads -->
                <div class="portfolio-uploads">
                    <div class="form-group upload-group">
                        <label>Portfolio Photo 1</label>
                        <input
                            type="file"
                            id="photo1"
                            name="photo1"
                            accept="image/*"
                        >
                        <div class="upload-preview" id="photo1-preview" style="display: none;">
                            <img id="photo1-img" alt="Portfolio photo 1">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo1')">✕</button>
                        </div>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 2</label>
                        <input
                            type="file"
                            id="photo2"
                            name="photo2"
                            accept="image/*"
                        >
                        <div class="upload-preview" id="photo2-preview" style="display: none;">
                            <img id="photo2-img" alt="Portfolio photo 2">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo2')">✕</button>
                        </div>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 3</label>
                        <input
                            type="file"
                            id="photo3"
                            name="photo3"
                            accept="image/*"
                        >
                        <div class="upload-preview" id="photo3-preview" style="display: none;">
                            <img id="photo3-img" alt="Portfolio photo 3">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo3')">✕</button>
                        </div>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 4</label>
                        <input
                            type="file"
                            id="photo4"
                            name="photo4"
                            accept="image/*"
                        >
                        <div class="upload-preview" id="photo4-preview" style="display: none;">
                            <img id="photo4-img" alt="Portfolio photo 4">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo4')">✕</button>
                        </div>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 5</label>
                        <input
                            type="file"
                            id="photo5"
                            name="photo5"
                            accept="image/*"
                        >
                        <div class="upload-preview" id="photo5-preview" style="display: none;">
                            <img id="photo5-img" alt="Portfolio photo 5">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo5')">✕</button>
                        </div>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 6</label>
                        <input
                            type="file"
                            id="photo6"
                            name="photo6"
                            accept="image/*"
                        >
                        <div class="upload-preview" id="photo6-preview" style="display: none;">
                            <img id="photo6-img" alt="Portfolio photo 6">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo6')">✕</button>
                        </div>
                    </div>
                </div>

                <div class="form-note">
                    <strong>Tips for great portfolio photos:</strong>
                    <ul>
                        <li>Show completed projects (before & after photos work great)</li>
                        <li>Use good lighting and clear angles</li>
                        <li>Include variety - different types of work you do</li>
                        <li>Keep photos professional and clutter-free</li>
                    </ul>
                </div>

                <div class="form-actions">
                    <a href="step3.html" class="btn btn-secondary">Back</a>
                    <button type="submit" id="submit-button" class="btn btn-primary">
                        Complete Registration
                    </button>
                </div>

                <p class="skip-note">
                    You can skip this step and add portfolio photos later from your dashboard.
                </p>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        if (!isAuthenticated()) {
            alert('Please complete Step 1 first');
            window.location.href = 'step1.html';
        }

        // Track uploaded photos
        const uploadedPhotos = {};

        // Setup file previews
        for (let i = 1; i <= 6; i++) {
            const input = document.getElementById(`photo${i}`);
            const preview = document.getElementById(`photo${i}-preview`);
            const img = document.getElementById(`photo${i}-img`);

            input.addEventListener('change', function() {
                const file = this.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                    uploadedPhotos[`photo${i}`] = file;
                }
            });
        }

        // Remove photo function
        window.removePhoto = function(photoId) {
            document.getElementById(photoId).value = '';
            document.getElementById(`${photoId}-preview`).style.display = 'none';
            delete uploadedPhotos[photoId];
        };

        // Handle form submission
        document.getElementById('portfolio-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();

            showLoading('submit-button');

            try {
                const portfolioUrls = [];

                // Upload all selected photos
                for (const [key, file] of Object.entries(uploadedPhotos)) {
                    if (file) {
                        const result = await uploadPortfolioPhoto(file);
                        portfolioUrls.push(result.url);
                    }
                }

                // Update profile with portfolio URLs if any were uploaded
                if (portfolioUrls.length > 0) {
                    await updateProfile({
                        portfolio_photos: portfolioUrls
                    });
                }

                // Save to draft
                saveRegistrationDraft({
                    portfolioPhotos: portfolioUrls,
                    registrationComplete: true
                });

                // Clear the registration role from localStorage
                localStorage.removeItem('registration_role');

                // Navigate to dashboard
                window.location.href = '/dashboard/';

            } catch (error) {
                hideLoading('submit-button');
                showError(error.message || 'Failed to upload photos. Please try again or skip this step.');
            }
        });
    </script>
</body>
</html>
