<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration - Step 4 | The Real Johnson</title>
    <link rel="stylesheet" href="style.css">
    <script src="../auth.js"></script>
</head>
<body>
    <div class="register-container">
        <div class="register-card">
            <div class="logo">
                <a href="/">The Real Johnson</a>
            </div>

            <div class="progress-bar">
                <div class="progress-step completed">1</div>
                <div class="progress-line completed"></div>
                <div class="progress-step completed">2</div>
                <div class="progress-line completed"></div>
                <div class="progress-step completed">3</div>
                <div class="progress-line completed"></div>
                <div class="progress-step active">4</div>
            </div>

            <h1>Portfolio Photos</h1>
            <p class="subtitle">Showcase your best work (optional but highly recommended)</p>

            <div id="error-message" class="error-message" style="display: none;"></div>

            <form id="portfolio-form" class="registration-form">
                <div class="info-box">
                    <strong>Why add portfolio photos?</strong>
                    <p>
                        Customers are 3x more likely to hire contractors with portfolio photos.
                        Show off your best work to stand out and win more jobs!
                    </p>
                </div>

                <!-- Portfolio Photo Uploads -->
                <div class="portfolio-uploads">
                    <div class="form-group upload-group">
                        <label>Portfolio Photo 1</label>
                        <input
                            type="file"
                            id="photo1"
                            name="photo1"
                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                        >
                        <div class="upload-preview" id="photo1-preview" style="display: none;">
                            <img id="photo1-img" alt="Portfolio photo 1">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo1')">✕</button>
                        </div>
                        <div class="upload-status" id="photo1-status" style="display: none;"></div>
                        <span class="field-error" id="photo1-error"></span>
                        <small>Max 10MB • JPG, PNG, GIF, WebP</small>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 2</label>
                        <input
                            type="file"
                            id="photo2"
                            name="photo2"
                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                        >
                        <div class="upload-preview" id="photo2-preview" style="display: none;">
                            <img id="photo2-img" alt="Portfolio photo 2">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo2')">✕</button>
                        </div>
                        <div class="upload-status" id="photo2-status" style="display: none;"></div>
                        <span class="field-error" id="photo2-error"></span>
                        <small>Max 10MB • JPG, PNG, GIF, WebP</small>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 3</label>
                        <input
                            type="file"
                            id="photo3"
                            name="photo3"
                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                        >
                        <div class="upload-preview" id="photo3-preview" style="display: none;">
                            <img id="photo3-img" alt="Portfolio photo 3">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo3')">✕</button>
                        </div>
                        <div class="upload-status" id="photo3-status" style="display: none;"></div>
                        <span class="field-error" id="photo3-error"></span>
                        <small>Max 10MB • JPG, PNG, GIF, WebP</small>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 4</label>
                        <input
                            type="file"
                            id="photo4"
                            name="photo4"
                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                        >
                        <div class="upload-preview" id="photo4-preview" style="display: none;">
                            <img id="photo4-img" alt="Portfolio photo 4">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo4')">✕</button>
                        </div>
                        <div class="upload-status" id="photo4-status" style="display: none;"></div>
                        <span class="field-error" id="photo4-error"></span>
                        <small>Max 10MB • JPG, PNG, GIF, WebP</small>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 5</label>
                        <input
                            type="file"
                            id="photo5"
                            name="photo5"
                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                        >
                        <div class="upload-preview" id="photo5-preview" style="display: none;">
                            <img id="photo5-img" alt="Portfolio photo 5">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo5')">✕</button>
                        </div>
                        <div class="upload-status" id="photo5-status" style="display: none;"></div>
                        <span class="field-error" id="photo5-error"></span>
                        <small>Max 10MB • JPG, PNG, GIF, WebP</small>
                    </div>

                    <div class="form-group upload-group">
                        <label>Portfolio Photo 6</label>
                        <input
                            type="file"
                            id="photo6"
                            name="photo6"
                            accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                        >
                        <div class="upload-preview" id="photo6-preview" style="display: none;">
                            <img id="photo6-img" alt="Portfolio photo 6">
                            <button type="button" class="remove-btn" onclick="removePhoto('photo6')">✕</button>
                        </div>
                        <div class="upload-status" id="photo6-status" style="display: none;"></div>
                        <span class="field-error" id="photo6-error"></span>
                        <small>Max 10MB • JPG, PNG, GIF, WebP</small>
                    </div>
                </div>

                <div class="form-note">
                    <strong>Tips for great portfolio photos:</strong>
                    <ul>
                        <li>Show completed projects (before & after photos work great)</li>
                        <li>Use good lighting and clear angles</li>
                        <li>Include variety - different types of work you do</li>
                        <li>Keep photos professional and clutter-free</li>
                    </ul>
                </div>

                <div class="form-actions">
                    <a href="step3.html" class="btn btn-secondary">Back</a>
                    <button type="submit" id="submit-button" class="btn btn-primary">
                        Complete Registration
                    </button>
                </div>

                <p class="skip-note">
                    You can skip this step and add portfolio photos later from your dashboard.
                </p>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        if (!isAuthenticated()) {
            alert('Please complete Step 1 first');
            window.location.href = 'step1.html';
        }

        // Track uploaded files and URLs
        const uploadedFiles = {};
        const uploadedUrls = {};

        // Setup file input handlers with validation
        for (let i = 1; i <= 6; i++) {
            const photoId = `photo${i}`;
            const input = document.getElementById(photoId);
            const preview = document.getElementById(`${photoId}-preview`);
            const img = document.getElementById(`${photoId}-img`);
            const errorEl = document.getElementById(`${photoId}-error`);
            const statusEl = document.getElementById(`${photoId}-status`);

            input.addEventListener('change', function() {
                const file = this.files[0];

                // Clear previous error and status
                errorEl.style.display = 'none';
                statusEl.style.display = 'none';
                preview.style.display = 'none';

                if (!file) {
                    uploadedFiles[photoId] = null;
                    uploadedUrls[photoId] = null;
                    return;
                }

                // Validate file
                const validation = validateFile(file, {
                    maxSize: 10 * 1024 * 1024, // 10MB
                    allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp']
                });

                if (!validation.valid) {
                    errorEl.textContent = validation.errors.join('. ');
                    errorEl.style.display = 'block';
                    this.value = ''; // Clear the invalid file
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);

                // Show file info
                statusEl.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                statusEl.style.display = 'block';
                statusEl.style.color = '#666';

                // Store file reference
                uploadedFiles[photoId] = file;
                uploadedUrls[photoId] = null; // Clear any previous upload
            });
        }

        // Remove photo function
        window.removePhoto = function(photoId) {
            const input = document.getElementById(photoId);
            const preview = document.getElementById(`${photoId}-preview`);
            const errorEl = document.getElementById(`${photoId}-error`);
            const statusEl = document.getElementById(`${photoId}-status`);

            input.value = '';
            preview.style.display = 'none';
            errorEl.style.display = 'none';
            statusEl.style.display = 'none';
            uploadedFiles[photoId] = null;
            uploadedUrls[photoId] = null;
        };

        // Helper function to upload a single photo with progress feedback
        async function uploadSinglePhoto(photoId, file) {
            const statusEl = document.getElementById(`${photoId}-status`);
            const errorEl = document.getElementById(`${photoId}-error`);

            try {
                // Show uploading status
                statusEl.textContent = `Uploading ${file.name}...`;
                statusEl.style.display = 'block';
                statusEl.style.color = '#FFA500';

                const result = await uploadPortfolioPhoto(file);

                // Show success
                statusEl.textContent = `✓ Uploaded successfully`;
                statusEl.style.color = '#4caf50';

                return result.url;
            } catch (error) {
                // Show error
                statusEl.textContent = '';
                statusEl.style.display = 'none';
                const friendlyError = getUserFriendlyError(error, 'upload');
                errorEl.textContent = friendlyError;
                errorEl.style.display = 'block';

                throw error;
            }
        }

        // Handle form submission
        document.getElementById('portfolio-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();

            // Check rate limit
            const rateCheck = checkRateLimit('register-step4');
            if (!rateCheck.allowed) {
                showError(`Please wait ${rateCheck.remainingSeconds} second${rateCheck.remainingSeconds > 1 ? 's' : ''} before trying again.`);
                showRateLimitMessage('submit-button', rateCheck.remainingSeconds);
                return;
            }

            // Check if we have any files to upload
            const hasFiles = Object.values(uploadedFiles).some(file => file !== null && file !== undefined);

            if (!hasFiles) {
                // Allow skipping portfolio step entirely
                saveRegistrationDraft({
                    portfolioPhotos: [],
                    registrationComplete: true
                });
                localStorage.removeItem('registration_role');
                window.location.href = '/dashboard/';
                return;
            }

            showLoading('submit-button');

            // Set rate limit
            setRateLimit('register-step4');

            try {
                const portfolioUrls = [];
                const uploadErrors = [];

                // Upload files one at a time to show progress
                for (let i = 1; i <= 6; i++) {
                    const photoId = `photo${i}`;
                    const file = uploadedFiles[photoId];

                    if (file && !uploadedUrls[photoId]) {
                        try {
                            const url = await uploadSinglePhoto(photoId, file);
                            uploadedUrls[photoId] = url;
                            portfolioUrls.push(url);
                        } catch (error) {
                            uploadErrors.push(`Photo ${i} failed to upload`);
                        }
                    } else if (uploadedUrls[photoId]) {
                        portfolioUrls.push(uploadedUrls[photoId]);
                    }
                }

                // If any uploads failed, allow retry or skip
                if (uploadErrors.length > 0) {
                    hideLoading('submit-button');
                    const confirmContinue = confirm(
                        'Some photos failed to upload. You can click Submit again to retry the failed uploads, or click Cancel to fix the issues first.'
                    );
                    if (!confirmContinue) {
                        return;
                    }
                    showLoading('submit-button');
                }

                // Update profile with portfolio URLs if any were uploaded
                if (portfolioUrls.length > 0) {
                    await updateProfile({
                        portfolio_photos: portfolioUrls
                    });
                }

                // Save to draft
                saveRegistrationDraft({
                    portfolioPhotos: portfolioUrls,
                    registrationComplete: true
                });

                // Clear the registration role from localStorage
                localStorage.removeItem('registration_role');

                // Navigate to dashboard
                window.location.href = '/dashboard/';

            } catch (error) {
                hideLoading('submit-button');
                showError(error, 'error-message', 'upload');
            }
        });
    </script>
</body>
</html>
