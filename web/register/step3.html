<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration - Step 3 | The Real Johnson</title>
    <link rel="stylesheet" href="style.css">
    <script src="../auth.js"></script>
</head>
<body>
    <div class="register-container">
        <div class="register-card">
            <div class="logo">
                <a href="/">The Real Johnson</a>
            </div>

            <div class="progress-bar">
                <div class="progress-step completed">1</div>
                <div class="progress-line completed"></div>
                <div class="progress-step completed">2</div>
                <div class="progress-line completed"></div>
                <div class="progress-step active">3</div>
                <div class="progress-line"></div>
                <div class="progress-step">4</div>
            </div>

            <h1>Your Skills & Experience</h1>
            <p class="subtitle">Tell customers what you can do</p>

            <div id="error-message" class="error-message" style="display: none;"></div>

            <form id="profile-form" class="registration-form">
                <!-- Skills Selection -->
                <div class="form-group">
                    <label>Services You Offer *</label>
                    <div class="skills-grid">
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Drywall">
                            <span>Drywall</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Painting">
                            <span>Painting</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Electrical">
                            <span>Electrical</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Plumbing">
                            <span>Plumbing</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Carpentry">
                            <span>Carpentry</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="HVAC">
                            <span>HVAC</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Flooring">
                            <span>Flooring</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Roofing">
                            <span>Roofing</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Landscaping">
                            <span>Landscaping</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Appliance">
                            <span>Appliance Repair</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Windows & Doors">
                            <span>Windows & Doors</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Other">
                            <span>Other</span>
                        </label>
                    </div>
                    <small>Select all services you're comfortable providing</small>
                </div>

                <!-- Business Address -->
                <div class="form-group">
                    <label for="businessAddress">Business Address *</label>
                    <input
                        type="text"
                        id="businessAddress"
                        name="businessAddress"
                        required
                        placeholder="123 Main St"
                    >
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input
                            type="text"
                            id="city"
                            name="city"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="state">State *</label>
                        <input
                            type="text"
                            id="state"
                            name="state"
                            required
                            maxlength="2"
                            placeholder="MD"
                        >
                    </div>

                    <div class="form-group">
                        <label for="zip">ZIP Code *</label>
                        <input
                            type="text"
                            id="zip"
                            name="zip"
                            required
                            pattern="[0-9]{5}"
                            placeholder="21201"
                        >
                    </div>
                </div>

                <small class="form-note">
                    We use your business address to show you jobs within 50 miles.
                    Your exact address is never shared with customers until you accept a job.
                </small>

                <!-- Years of Experience -->
                <div class="form-group">
                    <label for="experience">Years of Experience *</label>
                    <select id="experience" name="experience" required>
                        <option value="">Select experience level</option>
                        <option value="0-1">Less than 1 year</option>
                        <option value="1-3">1-3 years</option>
                        <option value="3-5">3-5 years</option>
                        <option value="5-10">5-10 years</option>
                        <option value="10+">10+ years</option>
                    </select>
                </div>

                <!-- Bio/Description -->
                <div class="form-group">
                    <label for="bio">About You (Optional)</label>
                    <textarea
                        id="bio"
                        name="bio"
                        rows="4"
                        maxlength="500"
                        placeholder="Tell customers about your background, specialties, and what makes you great at what you do..."
                    ></textarea>
                    <small><span id="bio-count">0</span>/500 characters</small>
                </div>

                <div class="form-actions">
                    <a href="step2.html" class="btn btn-secondary">Back</a>
                    <button type="submit" id="submit-button" class="btn btn-primary">
                        Continue to Portfolio
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        if (!isAuthenticated()) {
            alert('Please complete Step 1 first');
            window.location.href = 'step1.html';
        }

        // Load draft data
        const draft = getRegistrationDraft();

        // Character counter for bio
        const bioInput = document.getElementById('bio');
        const bioCount = document.getElementById('bio-count');
        bioInput.addEventListener('input', function() {
            bioCount.textContent = this.value.length;
        });

        // Load previous data if exists
        if (draft.skills) {
            draft.skills.forEach(skill => {
                const checkbox = document.querySelector(`input[value="${skill}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        if (draft.businessAddress) document.getElementById('businessAddress').value = draft.businessAddress;
        if (draft.city) document.getElementById('city').value = draft.city;
        if (draft.state) document.getElementById('state').value = draft.state;
        if (draft.zip) document.getElementById('zip').value = draft.zip;
        if (draft.experience) document.getElementById('experience').value = draft.experience;
        if (draft.bio) {
            bioInput.value = draft.bio;
            bioCount.textContent = draft.bio.length;
        }

        // Handle form submission
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();

            // Get selected skills
            const skillCheckboxes = document.querySelectorAll('input[name="skills"]:checked');
            const skills = Array.from(skillCheckboxes).map(cb => cb.value);

            if (skills.length === 0) {
                showError('Please select at least one service you can provide');
                return;
            }

            // Get form values
            const businessAddress = document.getElementById('businessAddress').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim().toUpperCase();
            const zip = document.getElementById('zip').value.trim();
            const experience = document.getElementById('experience').value;
            const bio = bioInput.value.trim();

            showLoading('submit-button');

            try {
                // Update profile with backend
                await updateProfile({
                    skills: skills,
                    business_address: {
                        street: businessAddress,
                        city: city,
                        state: state,
                        zip: zip
                    },
                    years_experience: experience,
                    bio: bio
                });

                // Save to draft
                saveRegistrationDraft({
                    skills,
                    businessAddress,
                    city,
                    state,
                    zip,
                    experience,
                    bio
                });

                // Navigate to step 4
                window.location.href = 'step4.html';

            } catch (error) {
                hideLoading('submit-button');
                showError(error.message || 'Failed to save profile. Please try again.');
            }
        });
    </script>
</body>
</html>
