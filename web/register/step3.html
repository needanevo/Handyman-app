<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Step 3: Skills & Experience | The Real Johnson</title>
    <meta name="description" content="Complete your contractor registration - share your skills, business location, and experience. Step 3 of 4 to join The Real Johnson platform.">

    <!-- OpenGraph Meta Tags -->
    <meta property="og:title" content="Contractor Registration Step 3 | The Real Johnson">
    <meta property="og:description" content="Share your skills and experience to complete your contractor profile">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://therealjohnson.com/register/step3">
    <meta property="og:image" content="https://therealjohnson.com/og-image.jpg">

    <!-- JSON-LD Schema -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        "name": "The Real Johnson",
        "description": "Platform connecting homeowners with skilled handymen and contractors",
        "url": "https://therealjohnson.com",
        "priceRange": "$$",
        "areaServed": "United States",
        "serviceType": ["Home Repair", "Handyman Services", "Contractor Services"]
    }
    </script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../assets/logo.svg">

    <link rel="stylesheet" href="../global.css">
    <link rel="stylesheet" href="style.css">
    <script src="../auth.js"></script>
</head>
<body>
    <a href="#main-content" class="skip-to-content" aria-label="Skip to main content">Skip to main content</a>

    <div class="register-container" id="main-content">
        <div class="register-card">
            <div class="logo">
                <a href="/" aria-label="The Real Johnson home page">
                    <img src="../assets/logo.svg" alt="The Real Johnson" class="logo-img">
                </a>
            </div>

            <div class="progress-bar" role="navigation" aria-label="Registration progress">
                <div class="progress-step completed" aria-label="Step 1 completed">1</div>
                <div class="progress-line completed" aria-hidden="true"></div>
                <div class="progress-step completed" aria-label="Step 2 completed">2</div>
                <div class="progress-line completed" aria-hidden="true"></div>
                <div class="progress-step active" aria-current="step" aria-label="Step 3 current">3</div>
                <div class="progress-line" aria-hidden="true"></div>
                <div class="progress-step" aria-label="Step 4 upcoming">4</div>
            </div>

            <h1>Your Skills & Experience</h1>
            <p class="subtitle">Tell customers what you can do</p>

            <div id="error-message" class="error-message" role="alert" aria-live="polite" style="display: none;"></div>

            <form id="profile-form" class="registration-form" aria-label="Skills and experience registration form">
                <!-- Skills Selection -->
                <div class="form-group">
                    <label>Services You Offer *</label>
                    <div class="skills-grid" role="group" aria-label="Select services you offer">
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Drywall">
                            <span>Drywall</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Painting">
                            <span>Painting</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Electrical">
                            <span>Electrical</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Plumbing">
                            <span>Plumbing</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Carpentry">
                            <span>Carpentry</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="HVAC">
                            <span>HVAC</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Flooring">
                            <span>Flooring</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Roofing">
                            <span>Roofing</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Landscaping">
                            <span>Landscaping</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Appliance">
                            <span>Appliance Repair</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Windows & Doors">
                            <span>Windows & Doors</span>
                        </label>
                        <label class="skill-checkbox">
                            <input type="checkbox" name="skills" value="Other">
                            <span>Other</span>
                        </label>
                    </div>
                    <span class="field-error" id="skills-error"></span>
                    <small>Select all services you're comfortable providing</small>
                </div>

                <!-- Business Address -->
                <div class="form-group">
                    <label for="businessAddress">Business Address *</label>
                    <input
                        type="text"
                        id="businessAddress"
                        name="businessAddress"
                        required
                        placeholder="123 Main St"
                        minlength="5"
                        maxlength="100"
                        aria-required="true"
                        aria-describedby="address-hint"
                    >
                    <span class="field-error" role="alert"></span>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input
                            type="text"
                            id="city"
                            name="city"
                            required
                            minlength="2"
                            maxlength="50"
                        >
                        <span class="field-error"></span>
                    </div>

                    <div class="form-group">
                        <label for="state">State *</label>
                        <input
                            type="text"
                            id="state"
                            name="state"
                            required
                            maxlength="2"
                            placeholder="MD"
                            pattern="[A-Z]{2}"
                            title="2-letter state code (e.g., MD, VA, DC)"
                        >
                        <span class="field-error"></span>
                    </div>

                    <div class="form-group">
                        <label for="zip">ZIP Code *</label>
                        <input
                            type="text"
                            id="zip"
                            name="zip"
                            required
                            pattern="[0-9]{5}"
                            placeholder="21201"
                            title="5-digit ZIP code"
                        >
                        <span class="field-error"></span>
                    </div>
                </div>

                <small class="form-note" id="address-hint">
                    We use your business address to show you jobs within 50 miles.
                    Your exact address is never shared with customers until you accept a job.
                </small>

                <!-- Years of Experience -->
                <div class="form-group">
                    <label for="experience">Years of Experience *</label>
                    <select id="experience" name="experience" required aria-required="true">
                        <option value="">Select experience level</option>
                        <option value="0-1">Less than 1 year</option>
                        <option value="1-3">1-3 years</option>
                        <option value="3-5">3-5 years</option>
                        <option value="5-10">5-10 years</option>
                        <option value="10+">10+ years</option>
                    </select>
                    <span class="field-error"></span>
                </div>

                <!-- Bio/Description -->
                <div class="form-group">
                    <label for="bio">About You (Optional)</label>
                    <textarea
                        id="bio"
                        name="bio"
                        rows="4"
                        maxlength="500"
                        placeholder="Tell customers about your background, specialties, and what makes you great at what you do..."
                    ></textarea>
                    <span class="field-error"></span>
                    <small><span id="bio-count">0</span>/500 characters</small>
                </div>

                <div class="form-actions">
                    <a href="step2.html" class="btn btn-secondary" aria-label="Go back to step 2">Back</a>
                    <button type="submit" id="submit-button" class="btn btn-primary" aria-label="Continue to portfolio upload">
                        Continue to Portfolio
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Check authentication
        if (!isAuthenticated()) {
            alert('Please complete Step 1 first');
            window.location.href = 'step1.html';
        }

        // Load draft data
        const draft = getRegistrationDraft();

        // Character counter for bio
        const bioInput = document.getElementById('bio');
        const bioCount = document.getElementById('bio-count');
        bioInput.addEventListener('input', function() {
            bioCount.textContent = this.value.length;
        });

        // Load previous data if exists
        if (draft.skills) {
            draft.skills.forEach(skill => {
                const checkbox = document.querySelector(`input[value="${skill}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
        if (draft.businessAddress) document.getElementById('businessAddress').value = draft.businessAddress;
        if (draft.city) document.getElementById('city').value = draft.city;
        if (draft.state) document.getElementById('state').value = draft.state;
        if (draft.zip) document.getElementById('zip').value = draft.zip;
        if (draft.experience) document.getElementById('experience').value = draft.experience;
        if (draft.bio) {
            bioInput.value = draft.bio;
            bioCount.textContent = draft.bio.length;
        }

        // ========== Skills Validation ==========
        const skillCheckboxes = document.querySelectorAll('input[name="skills"]');
        const skillsError = document.getElementById('skills-error');

        function validateSkills() {
            const checkedSkills = document.querySelectorAll('input[name="skills"]:checked');
            if (checkedSkills.length === 0) {
                skillsError.textContent = 'Please select at least one service';
                skillsError.style.display = 'block';
                return false;
            } else {
                skillsError.style.display = 'none';
                return true;
            }
        }

        // Real-time skills validation
        skillCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Only validate if user has interacted
                if (document.querySelector('input[name="skills"]:checked') ||
                    skillsError.style.display === 'block') {
                    validateSkills();
                }
            });
        });

        // ========== Address Field Validation ==========
        const requiredInputs = [
            document.getElementById('businessAddress'),
            document.getElementById('city'),
            document.getElementById('state'),
            document.getElementById('zip')
        ];

        const experienceSelect = document.getElementById('experience');

        // Setup real-time validation for all required inputs
        requiredInputs.forEach(input => {
            // Validate on blur
            input.addEventListener('blur', function() {
                if (this.value) {
                    validateField(this, true);
                }
            });

            // Clear error on focus
            input.addEventListener('focus', function() {
                const errorEl = this.parentElement.querySelector('.field-error');
                if (errorEl) errorEl.style.display = 'none';
                this.classList.remove('error');
            });

            // Validate on input for real-time feedback after first blur
            input.addEventListener('input', function() {
                if (this.classList.contains('error') || this.classList.contains('valid')) {
                    validateField(this, true);
                }
            });
        });

        // State field: auto-uppercase
        const stateInput = document.getElementById('state');
        stateInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        // ZIP field: only allow digits
        const zipInput = document.getElementById('zip');
        zipInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 5);
        });

        // Experience select validation
        experienceSelect.addEventListener('change', function() {
            validateField(this, true);
        });

        experienceSelect.addEventListener('focus', function() {
            const errorEl = this.parentElement.querySelector('.field-error');
            if (errorEl) errorEl.style.display = 'none';
            this.classList.remove('error');
        });

        // ========== Form Submission ==========
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();

            // Check rate limit
            const rateCheck = checkRateLimit('register-step3');
            if (!rateCheck.allowed) {
                showError(`Please wait ${rateCheck.remainingSeconds} second${rateCheck.remainingSeconds > 1 ? 's' : ''} before trying again.`);
                showRateLimitMessage('submit-button', rateCheck.remainingSeconds);
                return;
            }

            // Validate all fields
            let hasErrors = false;

            // Validate skills
            if (!validateSkills()) {
                hasErrors = true;
            }

            // Validate required inputs
            requiredInputs.forEach(input => {
                if (!validateField(input, true)) {
                    hasErrors = true;
                }
            });

            // Validate experience
            if (!validateField(experienceSelect, true)) {
                hasErrors = true;
            }

            if (hasErrors) {
                showError('Please fix the errors in the form before continuing.');
                // Scroll to first error
                const firstError = document.querySelector('.field-error[style*="block"]') || skillsError;
                if (firstError.style.display === 'block') {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            // Get selected skills
            const selectedSkills = Array.from(document.querySelectorAll('input[name="skills"]:checked'))
                .map(cb => cb.value);

            // Get form values
            const businessAddress = document.getElementById('businessAddress').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = stateInput.value.trim();
            const zip = zipInput.value.trim();
            const experience = experienceSelect.value;
            const bio = bioInput.value.trim();

            showLoading('submit-button');

            // Set rate limit
            setRateLimit('register-step3');

            try {
                // Update profile with backend
                await updateProfile({
                    skills: selectedSkills,
                    business_address: {
                        street: businessAddress,
                        city: city,
                        state: state,
                        zip: zip
                    },
                    years_experience: experience,
                    bio: bio
                });

                // Save to draft
                saveRegistrationDraft({
                    skills: selectedSkills,
                    businessAddress,
                    city,
                    state,
                    zip,
                    experience,
                    bio
                });

                // Navigate to step 4
                window.location.href = 'step4.html';

            } catch (error) {
                hideLoading('submit-button');
                showError(error, 'error-message', 'profile');
            }
        });
    </script>
</body>
</html>
