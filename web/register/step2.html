<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration - Step 2 | The Real Johnson</title>
    <meta name="description" content="Upload credentials - Step 2 of 4. Provide professional licenses and insurance certificates for your contractor account.">

    <!-- OpenGraph Meta Tags -->
    <meta property="og:title" content="Registration - Step 2 | The Real Johnson">
    <meta property="og:description" content="Upload your professional credentials and start building your business.">
    <meta property="og:type" content="website">

    <link rel="stylesheet" href="../global.css">
    <link rel="stylesheet" href="style.css">
    <script src="../auth.js"></script>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <main id="main-content" class="register-container" role="main">
        <div class="register-card">
            <div class="logo">
                <a href="/" aria-label="Return to homepage">The Real Johnson</a>
            </div>

            <div class="progress-bar" role="progressbar" aria-valuenow="2" aria-valuemin="1" aria-valuemax="4" aria-label="Registration progress: Step 2 of 4">
                <div class="progress-step completed">1</div>
                <div class="progress-line completed" aria-hidden="true"></div>
                <div class="progress-step active" aria-current="step">2</div>
                <div class="progress-line" aria-hidden="true"></div>
                <div class="progress-step">3</div>
                <div class="progress-line" aria-hidden="true"></div>
                <div class="progress-step">4</div>
            </div>

            <h1>Documents & Credentials</h1>
            <p class="subtitle" id="subtitle"></p>

            <div id="error-message" class="error-message" style="display: none;" role="alert" aria-live="polite"></div>

            <form id="documents-form" class="registration-form" aria-label="Registration form - Step 2">
                <!-- License Upload -->
                <div class="form-group upload-group">
                    <label for="license">
                        Professional License <span id="license-required"></span>
                    </label>
                    <input
                        type="file"
                        id="license"
                        name="license"
                        accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,application/pdf"
                        aria-label="Upload professional license"
                        aria-describedby="license-help"
                    >
                    <div class="upload-preview" id="license-preview" style="display: none;">
                        <img id="license-img" alt="License preview">
                        <button type="button" class="remove-btn" onclick="removeFile('license')" aria-label="Remove license file">✕</button>
                    </div>
                    <div class="upload-status" id="license-status" style="display: none;" role="status" aria-live="polite"></div>
                    <span class="field-error" id="license-error" role="alert"></span>
                    <small id="license-help">Max 10MB • JPG, PNG, GIF, WebP, or PDF</small>
                </div>

                <!-- Insurance Upload -->
                <div class="form-group upload-group">
                    <label for="insurance">
                        Insurance Certificate <span id="insurance-required"></span>
                    </label>
                    <input
                        type="file"
                        id="insurance"
                        name="insurance"
                        accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,application/pdf"
                        aria-label="Upload insurance certificate"
                        aria-describedby="insurance-help"
                    >
                    <div class="upload-preview" id="insurance-preview" style="display: none;">
                        <img id="insurance-img" alt="Insurance preview">
                        <button type="button" class="remove-btn" onclick="removeFile('insurance')" aria-label="Remove insurance file">✕</button>
                    </div>
                    <div class="upload-status" id="insurance-status" style="display: none;" role="status" aria-live="polite"></div>
                    <span class="field-error" id="insurance-error" role="alert"></span>
                    <small id="insurance-help">Max 10MB • JPG, PNG, GIF, WebP, or PDF</small>
                </div>

                <!-- Business License Upload -->
                <div class="form-group upload-group">
                    <label for="businessLicense">
                        Business License (Optional)
                    </label>
                    <input
                        type="file"
                        id="businessLicense"
                        name="businessLicense"
                        accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,application/pdf"
                        aria-label="Upload business license (optional)"
                        aria-describedby="business-license-help"
                    >
                    <div class="upload-preview" id="businessLicense-preview" style="display: none;">
                        <img id="businessLicense-img" alt="Business license preview">
                        <button type="button" class="remove-btn" onclick="removeFile('businessLicense')" aria-label="Remove business license file">✕</button>
                    </div>
                    <div class="upload-status" id="businessLicense-status" style="display: none;" role="status" aria-live="polite"></div>
                    <span class="field-error" id="businessLicense-error" role="alert"></span>
                    <small id="business-license-help">Max 10MB • JPG, PNG, GIF, WebP, or PDF</small>
                </div>

                <div class="info-box">
                    <strong id="role-info-title"></strong>
                    <p id="role-info-text"></p>
                </div>

                <div class="form-actions">
                    <a href="step1.html" class="btn btn-secondary" aria-label="Go back to step 1">Back</a>
                    <button type="submit" id="submit-button" class="btn btn-primary" aria-label="Continue to step 3: Profile">
                        Continue to Profile
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Check authentication
        if (!isAuthenticated()) {
            alert('Please complete Step 1 first');
            window.location.href = 'step1.html';
        }

        // Get role and draft data
        const draft = getRegistrationDraft();
        const role = draft.role || localStorage.getItem('registration_role') || 'HANDYMAN';

        // Track uploaded files
        let uploadedFiles = {
            license: null,
            insurance: null,
            businessLicense: null
        };

        // Configure page based on role
        const isContractor = role === 'TECHNICIAN';

        if (isContractor) {
            document.getElementById('subtitle').textContent = 'Licensed contractors must provide credentials';
            document.getElementById('license-required').innerHTML = '<span class="required">*</span>';
            document.getElementById('insurance-required').innerHTML = '<span class="required">*</span>';
            document.getElementById('license').required = true;
            document.getElementById('insurance').required = true;
            document.getElementById('role-info-title').textContent = 'Professional Contractor Requirements';
            document.getElementById('role-info-text').textContent = 'As a licensed contractor, you must upload your professional license and insurance certificate. These help customers trust your expertise and protect everyone involved.';
        } else {
            document.getElementById('subtitle').textContent = 'Upload credentials if you have them (optional for handymen)';
            document.getElementById('role-info-title').textContent = 'Handyman - Build As You Go';
            document.getElementById('role-info-text').textContent = 'Documents are optional for handymen. You can start working right away and add credentials later as you grow your business. Having licenses and insurance will help you access higher-value jobs over time.';
        }

        // Track upload URLs (for successfully uploaded files)
        let uploadedUrls = {
            license: null,
            insurance: null,
            businessLicense: null
        };

        // Handle file selection with validation and preview
        ['license', 'insurance', 'businessLicense'].forEach(fieldName => {
            const input = document.getElementById(fieldName);
            const preview = document.getElementById(`${fieldName}-preview`);
            const img = document.getElementById(`${fieldName}-img`);
            const errorEl = document.getElementById(`${fieldName}-error`);
            const statusEl = document.getElementById(`${fieldName}-status`);

            input.addEventListener('change', async function() {
                const file = this.files[0];

                // Clear previous error and status
                errorEl.style.display = 'none';
                statusEl.style.display = 'none';
                preview.style.display = 'none';

                if (!file) {
                    uploadedFiles[fieldName] = null;
                    uploadedUrls[fieldName] = null;
                    return;
                }

                // Validate file
                const validation = validateFile(file, {
                    maxSize: 10 * 1024 * 1024, // 10MB
                    allowedTypes: ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'application/pdf']
                });

                if (!validation.valid) {
                    errorEl.textContent = validation.errors.join('. ');
                    errorEl.style.display = 'block';
                    this.value = ''; // Clear the invalid file
                    return;
                }

                // Show preview for images
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    // For PDFs, show placeholder
                    img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Ctext x="50%25" y="50%25" font-size="40" text-anchor="middle" dy=".3em"%3EPDF%3C/text%3E%3C/svg%3E';
                    preview.style.display = 'block';
                }

                // Show file info
                statusEl.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                statusEl.style.display = 'block';
                statusEl.style.color = '#666';

                // Store file reference
                uploadedFiles[fieldName] = file;
                uploadedUrls[fieldName] = null; // Clear any previous upload
            });
        });

        // Remove file function
        window.removeFile = function(fieldName) {
            const input = document.getElementById(fieldName);
            const preview = document.getElementById(`${fieldName}-preview`);
            const errorEl = document.getElementById(`${fieldName}-error`);
            const statusEl = document.getElementById(`${fieldName}-status`);

            input.value = '';
            preview.style.display = 'none';
            errorEl.style.display = 'none';
            statusEl.style.display = 'none';
            uploadedFiles[fieldName] = null;
            uploadedUrls[fieldName] = null;
        };

        // Helper function to upload a single file with progress feedback
        async function uploadSingleFile(fieldName, file, documentType) {
            const statusEl = document.getElementById(`${fieldName}-status`);
            const errorEl = document.getElementById(`${fieldName}-error`);

            try {
                // Show uploading status
                statusEl.textContent = `Uploading ${file.name}...`;
                statusEl.style.display = 'block';
                statusEl.style.color = '#FFA500';

                const result = await uploadDocument(file, documentType);

                // Show success
                statusEl.textContent = `✓ Uploaded successfully`;
                statusEl.style.color = '#4caf50';

                return result.url;
            } catch (error) {
                // Show error
                statusEl.textContent = '';
                statusEl.style.display = 'none';
                const friendlyError = getUserFriendlyError(error, 'upload');
                errorEl.textContent = friendlyError;
                errorEl.style.display = 'block';

                throw error;
            }
        }

        // Handle form submission
        document.getElementById('documents-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            hideError();

            // Check rate limit
            const rateCheck = checkRateLimit('register-step2');
            if (!rateCheck.allowed) {
                showError(`Please wait ${rateCheck.remainingSeconds} second${rateCheck.remainingSeconds > 1 ? 's' : ''} before trying again.`);
                showRateLimitMessage('submit-button', rateCheck.remainingSeconds);
                return;
            }

            // Validate required fields for contractors
            if (isContractor) {
                if (!uploadedFiles.license) {
                    showError('Professional license is required for contractors. Please select a file.');
                    document.getElementById('license').focus();
                    return;
                }
                if (!uploadedFiles.insurance) {
                    showError('Insurance certificate is required for contractors. Please select a file.');
                    document.getElementById('insurance').focus();
                    return;
                }
            }

            // Check if we have any files to upload
            const hasFiles = uploadedFiles.license || uploadedFiles.insurance || uploadedFiles.businessLicense;
            if (!hasFiles && !isContractor) {
                // Allow handymen to skip this step if no files selected
                saveRegistrationDraft({
                    documents: {}
                });
                window.location.href = 'step3.html';
                return;
            }

            showLoading('submit-button');

            // Set rate limit
            setRateLimit('register-step2');

            try {
                const uploadResults = {};
                const uploadErrors = [];

                // Upload files one at a time to show progress
                if (uploadedFiles.license && !uploadedUrls.license) {
                    try {
                        uploadResults.license = await uploadSingleFile('license', uploadedFiles.license, 'license');
                        uploadedUrls.license = uploadResults.license;
                    } catch (error) {
                        uploadErrors.push('Failed to upload license');
                    }
                } else if (uploadedUrls.license) {
                    uploadResults.license = uploadedUrls.license;
                }

                if (uploadedFiles.insurance && !uploadedUrls.insurance) {
                    try {
                        uploadResults.insurance = await uploadSingleFile('insurance', uploadedFiles.insurance, 'insurance');
                        uploadedUrls.insurance = uploadResults.insurance;
                    } catch (error) {
                        uploadErrors.push('Failed to upload insurance');
                    }
                } else if (uploadedUrls.insurance) {
                    uploadResults.insurance = uploadedUrls.insurance;
                }

                if (uploadedFiles.businessLicense && !uploadedUrls.businessLicense) {
                    try {
                        uploadResults.businessLicense = await uploadSingleFile('businessLicense', uploadedFiles.businessLicense, 'business_license');
                        uploadedUrls.businessLicense = uploadResults.businessLicense;
                    } catch (error) {
                        uploadErrors.push('Failed to upload business license');
                    }
                } else if (uploadedUrls.businessLicense) {
                    uploadResults.businessLicense = uploadedUrls.businessLicense;
                }

                // Check if required uploads failed
                if (isContractor) {
                    if (!uploadResults.license || !uploadResults.insurance) {
                        hideLoading('submit-button');
                        showError('Required documents failed to upload. Please check the errors above and try again.');
                        return;
                    }
                }

                // If any non-required uploads failed, warn but allow to continue
                if (uploadErrors.length > 0 && !isContractor) {
                    hideLoading('submit-button');
                    const confirmContinue = confirm(
                        'Some documents failed to upload. You can continue without them and add them later, or click Cancel to try uploading again.'
                    );
                    if (!confirmContinue) {
                        return;
                    }
                    showLoading('submit-button');
                }

                // Save to draft
                saveRegistrationDraft({
                    documents: uploadResults
                });

                // Navigate to step 3
                window.location.href = 'step3.html';

            } catch (error) {
                hideLoading('submit-button');
                showError(error, 'error-message', 'upload');
            }
        });
    </script>
</body>
</html>
